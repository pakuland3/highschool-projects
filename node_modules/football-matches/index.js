
const {get} = require('got')
const config = require('./config')
const teams = require('./teams')

const PLAYED = 'FINISHED'

const getMatchesFromApi = async (team, apiKey) => {
  if (!apiKey) {
    throw new Error('You must provide an API key')
  }
  const res = await get(`${config.api}/teams/${team}/fixtures`, {
    headers: {
      'X-Auth-Token': apiKey
    }
  })
  const fixtures = JSON.parse(res.body).fixtures
  return fixtures
}

const parseOptions = options => Object.assign({}, {
  played: false,
  apiKey: ''
}, options)

const wasPlayed = match => match.status === PLAYED

const filterPlayed = matches => matches.filter(m => !wasPlayed(m))

const filter = (matches, options) => {
  matches = filterPlayed(matches)
  return matches
}

const matches = async (team, options) => {
  const teamId = teams[team] || -1
  options = parseOptions(options)

  if (teamId === -1) {
    throw new Error(`Unknown team ${team}`)
  }

  let matches = await getMatchesFromApi(teamId, options.apiKey)
  matches = filter(matches)

  return matches
}

matches.PLAYED = PLAYED

module.exports = matches
